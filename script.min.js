const SCENE=document.getElementById("scene"),DECOR=document.getElementById("sol");OBSTACLES=document.querySelectorAll("[data-obstacle]"),CONTENEUR=document.querySelector("[data-conteneur]"),JAUGE=document.getElementById("jauge-degat"),GRAVITE=100,SPRITE={SRC:"_media/sprite.gif",EXPLOSION:{X:106,Y:0},DEGAT:{X:0,Y:0},CRATERE:{X:202,Y:224,W:45,H:17},SOL:{X:202,Y:326,W:45,H:90},ETOILE:{X:202,Y:0,W:45,H:45},ENTREPOT:{X:202,Y:432,W:142,H:124},PINCE:{X:0,Y:155,W:83,H:38}};let vaisseau={x:50,y:100,element:document.getElementById("vaisseau"),reacteur:document.getElementById("reacteur"),vitesse:15,inclinaison:10,degat:0,boom:document.getElementById("boom"),pince:document.getElementById("pince"),pinceHitbox:document.getElementById("hitbox-pince"),vie:1},chargementPossible=!1,toucheClavier,Timer=(OBSTACLES.forEach(function(e,t){e.setAttribute("id","obstacle-"+t)}),function(e,t){var i=setInterval(e,t);this.stop=function(){return i&&(clearInterval(i),i=null),this},this.start=function(){return i||(this.stop(),i=setInterval(e,t)),this},this.reset=function(e=t){return t=e,this.stop().start()}}),chiffreAleatoire=function(e,t=0){return Math.round(Math.random()*(e-t)+t)},supprimeValeurDunTableau=function(e,t){e=t.indexOf(e);-1<e&&t.splice(e,1)};const animationSprite=class{constructor(e,t,i,a,s,n){this.spriteY=e,this.spriteX=t,this.spriteH=i,this.element=a,this.nombreEtape=s,this.delai=n,this.currentEtape=0,this.animation=setInterval(this.start.bind(this),this.delai)}start(){this.nombreEtape<=this.currentEtape?(this.stop(),this.element.style.backgroundPosition=`-${this.spriteX}px -${this.spriteY}px`):(this.element.style.backgroundPosition=`-${this.spriteX}px -${this.spriteY+this.spriteH*this.currentEtape}px`,this.verif(),this.currentEtape=++this.currentEtape)}stop(){clearInterval(this.animation)}verif(){}},animationSpriteExplosion=class extends animationSprite{verif(){4==this.currentEtape&&(vaisseau.element.style.backgroundImage="none",vaisseau.reacteur.style.backgroundImage="none")}},animationSpriteChargement=class extends animationSprite{verif(){7==this.currentEtape&&(this.element.style.backgroundPosition="0px -421px",this.element.style.height="48px",this.stop(),CONTENEUR.style.display="none")}};function enCollisionVaisseau(e,t){return e.x<t.offsetLeft+t.offsetWidth&&e.x+e.element.offsetWidth>t.offsetLeft&&e.y<t.offsetTop+t.offsetHeight&&e.y+e.element.offsetHeight>t.offsetTop}function enCollision(e,t){e=e.getBoundingClientRect(),t=t.getBoundingClientRect();return!(e.top+e.height<t.top||e.top>t.top+t.height||e.left+e.width<t.left||e.left>t.left+t.width)}let hitbox=function(t,e,i,a){let s=!0,n=!0,o=!0,r=!0;t.element.offsetTop+t.element.clientHeight-1===a.offsetTop&&(gravite.stop(),goto(e,i,"haut"),OBSTACLES.forEach(function(e){enCollisionVaisseau(t,e)&&e.id!=a.id&&(s=!1)}),s&&goto(e,i,"horizontal"),infligeDegat(t,a)),t.element.offsetTop-1===a.offsetTop+a.clientHeight&&(goto(e,i,"bas"),OBSTACLES.forEach(function(e){enCollisionVaisseau(t,e)&&e.id!=a.id&&(n=!1)}),n&&goto(e,i,"horizontal"),infligeDegat(t,a)),t.element.offsetLeft-1===a.offsetLeft+a.clientWidth&&(goto(e,i,"droite"),OBSTACLES.forEach(function(e){enCollisionVaisseau(t,e)&&e.id!=a.id&&(r=!1)}),r&&goto(e,i,"vertical"),infligeDegat(t,a)),t.element.offsetLeft+t.element.clientWidth-1===a.offsetLeft&&(goto(e,i,"gauche"),OBSTACLES.forEach(function(e){enCollisionVaisseau(t,e)&&e.id!=a.id&&(o=!1)}),o&&goto(e,i,"vertical"),infligeDegat(t,a))};const chargement=function(){new animationSpriteChargement(SPRITE.PINCE.Y,SPRITE.PINCE.X,SPRITE.PINCE.H,vaisseau.pince,8,50)};DECOR.setAttribute("width",SCENE.clientWidth),DECOR.setAttribute("height",SCENE.clientHeight);let ajouteEtoile=function(i,a,s){const e=Math.ceil(SCENE.clientWidth/SPRITE.ETOILE.W),n=Math.ceil(SCENE.clientHeight/SPRITE.ETOILE.H);a.onload=()=>{for(let t=0;t<e;t++)for(let e=0;e<n;e++)1==chiffreAleatoire(30,0)&&i.drawImage(a,SPRITE.ETOILE.X,s,SPRITE.ETOILE.W,SPRITE.ETOILE.H,t*SPRITE.ETOILE.W,e*SPRITE.ETOILE.H,SPRITE.ETOILE.W,SPRITE.ETOILE.H)},a.src=SPRITE.SRC},dessineLeDecor=function(){const i=DECOR.getContext("2d"),e=new Image,t=new Image,a=new Image,s=new Image,n=new Image,o=new Image,r=new Image,E=new Image,l=SCENE.clientHeight-SPRITE.SOL.H;i.fillRect(0,0,SCENE.clientWidth,SCENE.clientHeight),ajouteEtoile(i,e,SPRITE.ETOILE.Y),ajouteEtoile(i,t,SPRITE.ETOILE.Y+SPRITE.ETOILE.H),ajouteEtoile(i,a,SPRITE.ETOILE.Y+2*SPRITE.ETOILE.H),ajouteEtoile(i,s,SPRITE.ETOILE.Y+3*SPRITE.ETOILE.H),ajouteEtoile(i,n,SPRITE.ETOILE.Y+4*SPRITE.ETOILE.H),o.onload=()=>{for(let e=0;e<Math.ceil(SCENE.clientWidth/SPRITE.SOL.W);e++)i.drawImage(o,SPRITE.SOL.X,SPRITE.SOL.Y,SPRITE.SOL.W,SPRITE.SOL.H,e*SPRITE.SOL.W,l,SPRITE.SOL.W,SPRITE.SOL.H)},o.src=SPRITE.SRC;let c=[];for(let e=0;e<6;e++)c[e]=""+(SPRITE.CRATERE.Y+e*SPRITE.CRATERE.H);r.onload=()=>{for(let e=0;e<6;e++){var t=chiffreAleatoire(c.length,1),t=c[t-1];i.drawImage(r,SPRITE.CRATERE.X,t,SPRITE.CRATERE.W,SPRITE.CRATERE.H,e*Math.ceil(SCENE.clientWidth/6),l+chiffreAleatoire(SPRITE.SOL.H-SPRITE.CRATERE.H,10),SPRITE.CRATERE.W,SPRITE.CRATERE.H),supprimeValeurDunTableau(t,c)}},r.src=SPRITE.SRC,E.onload=()=>{i.drawImage(E,SPRITE.ENTREPOT.X,SPRITE.ENTREPOT.Y,SPRITE.ENTREPOT.W,SPRITE.ENTREPOT.H,40,SCENE.clientHeight-(SPRITE.ENTREPOT.H+20),SPRITE.ENTREPOT.W,SPRITE.ENTREPOT.H)},E.src=SPRITE.SRC},infligeDegat=(dessineLeDecor(),function(e,t){100<=Math.round(e.degat)?0<e.vie&&(new animationSpriteExplosion(SPRITE.EXPLOSION.Y,SPRITE.EXPLOSION.X,e.boom.clientHeight,e.boom,9,100),e.vie--):t.hasAttribute("data-degat")&&(e.degat+=1/e.vitesse,new animationSprite(SPRITE.DEGAT.Y,SPRITE.DEGAT.X,e.element.clientHeight,e.element,4,100),JAUGE.style.clipPath=`polygon(0 0, ${e.degat}% 0, ${e.degat}% 100%, 0 100%)`)}),keys={UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",LEFT:"ArrowLeft"},detectionClavier=(document.addEventListener("keydown",function(e){detectionClavier(e),gravite.stop()}),document.addEventListener("keyup",function(e){detectionClavier(e),vaisseau.element.style.transform="",vaisseau.reacteur.style.transform="",gravite.start()}),function(e){e.preventDefault();var t=e.key;keys[t]="keydown"==e.type,toucheClavier=t}),goto=function(e,t,i){switch(i){case"horizontal":vaisseau.x+=e||0;break;case"vertical":vaisseau.y+=t||0;break;case"haut":-1===t&&(vaisseau.y+=t||0);break;case"droite":1===e&&(vaisseau.x+=e||0);break;case"bas":1===t&&(vaisseau.y+=t||0);break;case"gauche":-1===e&&(vaisseau.x+=e||0)}},deplaceVaisseau=function(i,a){for(var e=0;e<vaisseau.vitesse;e++){let t=!0;OBSTACLES.forEach(function(e){enCollisionVaisseau(vaisseau,e)?(t=!1,hitbox(vaisseau,i,a,e)):(e.style.borderTopColor=null,e.style.borderRightColor=null,e.style.borderBottomColor=null,e.style.borderLeftColor=null)}),enCollision(vaisseau.pinceHitbox,CONTENEUR)&&" "===toucheClavier&&chargement(),t&&(goto(i,a,"horizontal"),goto(i,a,"vertical")),vaisseau.element.style.left=vaisseau.x+"px",vaisseau.element.style.top=vaisseau.y+"px"}};var controlVaisseau=function(){vaisseau.reacteur.classList.remove(vaisseau.reacteur.dataset.boost),keys[keys.UP]&&(deplaceVaisseau(0,-1),vaisseau.reacteur.classList.add(vaisseau.reacteur.dataset.boost)),keys[keys.RIGHT]&&(deplaceVaisseau(1,0),vaisseau.element.style.transform=`rotate(${vaisseau.inclinaison}deg)`,vaisseau.reacteur.style.transform=`rotate(${90-vaisseau.inclinaison}deg)`),keys[keys.DOWN]&&(deplaceVaisseau(0,1),vaisseau.reacteur.style.transform="rotate(180deg)"),keys[keys.LEFT]&&(deplaceVaisseau(-1,0),vaisseau.element.style.transform=`rotate(-${vaisseau.inclinaison}deg)`,vaisseau.reacteur.style.transform=`rotate(-${90-vaisseau.inclinaison}deg)`),keys[keys.DOWN]&&keys[keys.LEFT]&&(vaisseau.reacteur.style.transform="rotate(-135deg)"),keys[keys.DOWN]&&keys[keys.RIGHT]&&(vaisseau.reacteur.style.transform="rotate(135deg)"),keys[keys.UP]&&keys[keys.LEFT]&&(vaisseau.reacteur.style.transform="rotate(-45deg)"),keys[keys.UP]&&keys[keys.RIGHT]&&(vaisseau.reacteur.style.transform="rotate(45deg)")},gravite=(deplaceVaisseau(),setInterval(function(){controlVaisseau()},1e3/24),new Timer(function(){deplaceVaisseau(0,1)},GRAVITE));