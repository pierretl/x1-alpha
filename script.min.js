const SCENE=document.getElementById("scene"),DECOR=document.getElementById("decor");OBSTACLES=document.querySelectorAll("[data-obstacle]"),CONTENEUR=document.querySelector("[data-conteneur]"),DESTINATIONS=document.querySelectorAll("[data-destination]"),JAUGE=document.getElementById("jauge-degat"),CARGAISON=document.getElementById("cargaison"),DIALOG_START=document.getElementById("dialogStart"),DIALOG_SATUT=document.getElementById("dialogStatut"),DIALOG_SECTION_PAUSE=document.getElementById("pauseSection"),DIALOG_SECTION_WIN=document.getElementById("winSection"),DIALOG_SECTION_LOOSE=document.getElementById("looseSection"),FORM_PARTIE=document.getElementById("formPartie"),BTN_RELANCER=document.getElementById("btnRelancer"),BTN_REJOUER=document.getElementById("btnRejouer"),BTN_JOUER=document.getElementById("btnJouer"),DELAI_GRAVITE=100,CSS_DESTINATION_ACTIF="--actif",CSS_DESTINATION_READY="--ready",SPRITE={SRC:"_media/sprite.gif",EXPLOSION:{X:106,Y:0},DEGAT:{X:0,Y:0},CRATERE:{X:202,Y:224,W:45,H:17},SOL:{X:202,Y:326,W:45,H:90},ETOILE:{X:202,Y:0,W:45,H:45},ENTREPOT:{X:202,Y:432,W:142,H:124},PINCE:{X:0,Y:155,W:83,H:31},CONTENEUR:{X:202,Y:556,W:29,H:18}};let vaisseau={x:50,y:100,element:document.getElementById("vaisseau"),reacteur:document.getElementById("reacteur"),vitesseMax:15,inclinaison:10,degat:0,boom:document.getElementById("boom"),pince:document.getElementById("pince"),cargaisonHitbox:document.getElementById("hitbox-cargaison"),vie:1,cargaison:!1},toucheClavier,acceleration=0,partie={statut:"pause",nombreConteneur:3},Timer=function(e,t){var a=setInterval(e,t);this.stop=function(){return a&&(clearInterval(a),a=null),this},this.start=function(){return a||(this.stop(),a=setInterval(e,t)),this},this.reset=function(e=t){return t=e,this.stop().start()}},chiffreAleatoire=function(e,t=0){return Math.round(Math.random()*(e-t)+t)},supprimeValeurDunTableau=function(e,t){e=t.indexOf(e);-1<e&&t.splice(e,1)};const ajoutId=function(e){e.forEach(function(a){a[0].forEach(function(e,t){e.setAttribute("id",a[1]+"-"+t)})})};ajoutId([[DESTINATIONS,"destination"],[OBSTACLES,"obstacle"]]);class EventEmitter{constructor(){this._events={}}on(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push(t)}removeListener(e,t){if(!this._events[e])throw new Error(`Can't remove a listener. Event "${e}" doesn't exits.`);this._events[e]=this._events[e].filter(e=>e!==t)}emit(e,t){if(!this._events[e])throw new Error(`Can't emit an event. Event "${e}" doesn't exits.`);this._events[e].forEach(e=>{e(t)})}}const animationSprite=function(t,a,n,i,s,o,r=!1,E=!1,c=!1){let u=E?i*s:0,l=E?s+1:1;requestAnimationFrame(function e(){setTimeout(function(){t.style.backgroundPosition=`-${a}px -${n+u}px`,r&&r.emit("frameEvent",{currentFrame:l,elementInteraction:c}),E?(u-=i,0<(l=--l)?(gravite.stop(),requestAnimationFrame(e)):0!=partie.nombreConteneur&&document.dispatchEvent(new KeyboardEvent("keyup",{key:"ArrowDown"}))):(u+=i,(l=++l)<=s?(gravite.stop(),requestAnimationFrame(e)):0!=partie.nombreConteneur&&document.dispatchEvent(new KeyboardEvent("keyup",{key:"ArrowDown"})))},o/s)})},consequenceExplosionVaisseau=e=>{4==e.currentFrame&&(vaisseau.element.style.backgroundImage="none",vaisseau.reacteur.style.backgroundImage="none",vaisseau.pince.style.backgroundImage="none"),10==e.currentFrame&&gameLoose()},consequenceVaisseauCharge=e=>{7==e.currentFrame&&(CONTENEUR.querySelector(".conteneur").style.display="none"),14==e.currentFrame&&1<partie.nombreConteneur&&(setTimeout(()=>{CARGAISON.style.transition="bottom 1s",CARGAISON.style.bottom=0},"800"),setTimeout(()=>{CONTENEUR.querySelector(".conteneur").removeAttribute("style"),dessineGargaison(partie.nombreConteneur-2)},"1800")),vaisseau.cargaison=!0},consequenceVaisseauDecharge=e=>{if(7==e.currentFrame&&(e.elementInteraction.querySelector(".conteneur").classList.remove("hide"),e.elementInteraction.classList.remove("--actif")),14==e.currentFrame){if(--partie.nombreConteneur,console.log("faire un animation pour faire disparaitre le conteneur"),0===partie.nombreConteneur)return void setTimeout(()=>{gameWin()},"1000");activeUneDestination()}vaisseau.cargaison=!1},consequenceDegatVaisseau=e=>{5==e.currentFrame&&vaisseau.element.style.removeProperty("background-position")};function enCollisionVaisseau(e,t){return e.x<t.offsetLeft+t.offsetWidth&&e.x+e.element.offsetWidth>t.offsetLeft&&e.y<t.offsetTop+t.offsetHeight&&e.y+e.element.offsetHeight>t.offsetTop}function enCollision(e,t){e=e.getBoundingClientRect(),t=t.getBoundingClientRect();return!(e.top+e.height<t.top||e.top>t.top+t.height||e.left+e.width<t.left||e.left>t.left+t.width)}let hitbox=function(t,e,a,n){let i=!0,s=!0,o=!0,r=!0;t.element.offsetTop+t.element.clientHeight-1===n.offsetTop&&(goto(e,a,"haut"),OBSTACLES.forEach(function(e){enCollisionVaisseau(t,e)&&e.id!=n.id&&(i=!1)}),i&&goto(e,a,"horizontal"),infligeDegat(t,n)),t.element.offsetTop-1===n.offsetTop+n.clientHeight&&(goto(e,a,"bas"),OBSTACLES.forEach(function(e){enCollisionVaisseau(t,e)&&e.id!=n.id&&(s=!1)}),s&&goto(e,a,"horizontal"),infligeDegat(t,n)),t.element.offsetLeft-1===n.offsetLeft+n.clientWidth&&(goto(e,a,"droite"),OBSTACLES.forEach(function(e){enCollisionVaisseau(t,e)&&e.id!=n.id&&(r=!1)}),r&&goto(e,a,"vertical"),infligeDegat(t,n)),t.element.offsetLeft+t.element.clientWidth-1===n.offsetLeft&&(goto(e,a,"gauche"),OBSTACLES.forEach(function(e){enCollisionVaisseau(t,e)&&e.id!=n.id&&(o=!1)}),o&&goto(e,a,"vertical"),infligeDegat(t,n))},ajouteEtoile=(DECOR.setAttribute("width",SCENE.clientWidth),DECOR.setAttribute("height",SCENE.clientHeight),function(a,n,i){const e=Math.ceil(SCENE.clientWidth/SPRITE.ETOILE.W),s=Math.ceil(SCENE.clientHeight/SPRITE.ETOILE.H);n.onload=()=>{for(let t=0;t<e;t++)for(let e=0;e<s;e++)1==chiffreAleatoire(30,0)&&a.drawImage(n,SPRITE.ETOILE.X,i,SPRITE.ETOILE.W,SPRITE.ETOILE.H,t*SPRITE.ETOILE.W,e*SPRITE.ETOILE.H,SPRITE.ETOILE.W,SPRITE.ETOILE.H)},n.src=SPRITE.SRC}),dessineLeDecor=function(){const a=DECOR.getContext("2d"),e=new Image,t=new Image,n=new Image,i=new Image,s=new Image,o=new Image,r=new Image,E=new Image,c=SCENE.clientHeight-SPRITE.SOL.H;a.fillRect(0,0,SCENE.clientWidth,SCENE.clientHeight),ajouteEtoile(a,e,SPRITE.ETOILE.Y),ajouteEtoile(a,t,SPRITE.ETOILE.Y+SPRITE.ETOILE.H),ajouteEtoile(a,n,SPRITE.ETOILE.Y+2*SPRITE.ETOILE.H),ajouteEtoile(a,i,SPRITE.ETOILE.Y+3*SPRITE.ETOILE.H),ajouteEtoile(a,s,SPRITE.ETOILE.Y+4*SPRITE.ETOILE.H),o.onload=()=>{for(let e=0;e<Math.ceil(SCENE.clientWidth/SPRITE.SOL.W);e++)a.drawImage(o,SPRITE.SOL.X,SPRITE.SOL.Y,SPRITE.SOL.W,SPRITE.SOL.H,e*SPRITE.SOL.W,c,SPRITE.SOL.W,SPRITE.SOL.H)},o.src=SPRITE.SRC;let u=[];for(let e=0;e<6;e++)u[e]=""+(SPRITE.CRATERE.Y+e*SPRITE.CRATERE.H);r.onload=()=>{for(let e=0;e<6;e++){var t=chiffreAleatoire(u.length,1),t=u[t-1];a.drawImage(r,SPRITE.CRATERE.X,t,SPRITE.CRATERE.W,SPRITE.CRATERE.H,e*Math.ceil(SCENE.clientWidth/6),c+chiffreAleatoire(SPRITE.SOL.H-SPRITE.CRATERE.H,10),SPRITE.CRATERE.W,SPRITE.CRATERE.H),supprimeValeurDunTableau(t,u)}},r.src=SPRITE.SRC,E.onload=()=>{a.drawImage(E,SPRITE.ENTREPOT.X,SPRITE.ENTREPOT.Y,SPRITE.ENTREPOT.W,SPRITE.ENTREPOT.H,40,SCENE.clientHeight-(SPRITE.ENTREPOT.H+20),SPRITE.ENTREPOT.W,SPRITE.ENTREPOT.H)},E.src=SPRITE.SRC},infligeDegat=(dessineLeDecor(),function(e,t){var a;100<=Math.round(e.degat)?0<e.vie&&(a=new EventEmitter,animationSprite(e.boom,SPRITE.EXPLOSION.X,SPRITE.EXPLOSION.Y,e.boom.clientHeight,10,500,a),a.on("frameEvent",consequenceExplosionVaisseau),e.vie--):t.hasAttribute("data-degat")&&(e.degat+=1,a=new EventEmitter,animationSprite(e.element,SPRITE.DEGAT.X,SPRITE.DEGAT.Y,e.element.clientHeight,5,100,a),a.on("frameEvent",consequenceDegatVaisseau),JAUGE.style.clipPath=`polygon(0 0, ${e.degat}% 0, ${e.degat}% 100%, 0 100%)`)}),keys={UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",LEFT:"ArrowLeft"},detectionClavier=(document.addEventListener("keydown",function(e){detectionClavier(e)}),document.addEventListener("keyup",function(e){detectionClavier(e),vaisseau.element.style.transform="",vaisseau.reacteur.style.transform="",acceleration=0,gravite.start(),"p"==toucheClavier&&gamePause()}),function(e){e.preventDefault();var t=e.key;keys[t]="keydown"==e.type,toucheClavier=t}),goto=function(e,t,a){switch(a){case"horizontal":vaisseau.x+=e||0;break;case"vertical":vaisseau.y+=t||0;break;case"haut":-1===t&&(vaisseau.y+=t||0);break;case"droite":1===e&&(vaisseau.x+=e||0);break;case"bas":1===t&&(vaisseau.y+=t||0);break;case"gauche":-1===e&&(vaisseau.x+=e||0)}},deplaceVaisseau=function(a,n){acceleration=++acceleration;for(var e,t=0;t<((e=acceleration)>vaisseau.vitesseMax?vaisseau.vitesseMax:e);t++){let t=!0;OBSTACLES.forEach(function(e){enCollisionVaisseau(vaisseau,e)?(t=!1,hitbox(vaisseau,a,n,e)):(e.style.borderTopColor=null,e.style.borderRightColor=null,e.style.borderBottomColor=null,e.style.borderLeftColor=null)}),DESTINATIONS.forEach(function(e){var t;"actif"==e.dataset.destination&&e.classList.add(CSS_DESTINATION_ACTIF),enCollision(vaisseau.cargaisonHitbox,e)&&"actif"==e.dataset.destination&&!0===vaisseau.cargaison?(e.classList.remove(CSS_DESTINATION_ACTIF),e.classList.add(CSS_DESTINATION_READY)," "===toucheClavier&&(e.dataset.destination="",e.classList.remove(CSS_DESTINATION_ACTIF),e.classList.remove(CSS_DESTINATION_READY),t=new EventEmitter,animationSprite(vaisseau.pince,SPRITE.PINCE.X,SPRITE.PINCE.Y,SPRITE.PINCE.H,14,500,t,!0,e),t.on("frameEvent",consequenceVaisseauDecharge))):e.classList.remove(CSS_DESTINATION_READY)}),enCollision(vaisseau.cargaisonHitbox,CONTENEUR)&&" "===toucheClavier&&!1===vaisseau.cargaison&&(e=new EventEmitter,animationSprite(vaisseau.pince,SPRITE.PINCE.X,SPRITE.PINCE.Y,SPRITE.PINCE.H,14,500,e),e.on("frameEvent",consequenceVaisseauCharge)),t&&(goto(a,n,"horizontal"),goto(a,n,"vertical")),vaisseau.element.style.left=vaisseau.x+"px",vaisseau.element.style.top=vaisseau.y+"px"}};var controlVaisseau=function(){vaisseau.reacteur.classList.remove(vaisseau.reacteur.dataset.boost),keys[keys.UP]&&(deplaceVaisseau(0,-1),vaisseau.reacteur.classList.add(vaisseau.reacteur.dataset.boost)),keys[keys.RIGHT]&&(deplaceVaisseau(1,0),vaisseau.element.style.transform=`rotate(${vaisseau.inclinaison}deg)`,vaisseau.reacteur.style.transform=`rotate(${90-vaisseau.inclinaison}deg)`),keys[keys.DOWN]&&(deplaceVaisseau(0,1),vaisseau.reacteur.style.transform="rotate(180deg)"),keys[keys.LEFT]&&(deplaceVaisseau(-1,0),vaisseau.element.style.transform=`rotate(-${vaisseau.inclinaison}deg)`,vaisseau.reacteur.style.transform=`rotate(-${90-vaisseau.inclinaison}deg)`),keys[keys.DOWN]&&keys[keys.LEFT]&&(vaisseau.reacteur.style.transform="rotate(-135deg)"),keys[keys.DOWN]&&keys[keys.RIGHT]&&(vaisseau.reacteur.style.transform="rotate(135deg)"),keys[keys.UP]&&keys[keys.LEFT]&&(vaisseau.reacteur.style.transform="rotate(-45deg)"),keys[keys.UP]&&keys[keys.RIGHT]&&(vaisseau.reacteur.style.transform="rotate(45deg)")},gravite=(deplaceVaisseau(),setInterval(function(){"pause"!=partie.statut&&controlVaisseau()},1e3/24),new Timer(function(){"pause"!=partie.statut&&deplaceVaisseau(0,1)},DELAI_GRAVITE));const activeUneDestination=function(){var e=Array.from(DESTINATIONS);e[Math.floor(Math.random()*e.length)].dataset.destination="actif"},dessineGargaison=(activeUneDestination(),function(t){SPRITE.CONTENEUR.H,SPRITE.CONTENEUR.H;CARGAISON.setAttribute("width",SPRITE.CONTENEUR.W),CARGAISON.setAttribute("height",SPRITE.CONTENEUR.H*t),CARGAISON.setAttribute("style",`bottom:${SPRITE.CONTENEUR.H}px;`);const a=CARGAISON.getContext("2d"),n=new Image;n.onload=()=>{for(let e=0;e<t;e++)a.drawImage(n,SPRITE.CONTENEUR.X,SPRITE.CONTENEUR.Y,SPRITE.CONTENEUR.W,SPRITE.CONTENEUR.H,0,e*SPRITE.CONTENEUR.H,SPRITE.CONTENEUR.W,SPRITE.CONTENEUR.H)},n.src=SPRITE.SRC});dessineGargaison(partie.nombreConteneur-1),BTN_RELANCER.addEventListener("click",function(){DIALOG_SATUT.close(),partie.statut="start"}),BTN_REJOUER.addEventListener("click",function(){DIALOG_START.showModal(),DIALOG_SATUT.close()}),FORM_PARTIE.addEventListener("submit",e=>{e.preventDefault(),DIALOG_START.close(),DIALOG_SATUT.close(),vaisseau.element.removeAttribute("style"),vaisseau.reacteur.removeAttribute("style"),vaisseau.pince.removeAttribute("style"),vaisseau.boom.removeAttribute("style"),JAUGE.removeAttribute("style"),CONTENEUR.querySelector(".conteneur").removeAttribute("style"),DESTINATIONS.forEach(function(e){e.querySelector(".conteneur").classList.add("hide")}),DIALOG_SECTION_WIN.classList.add("hide"),partie.nombreConteneur=difficulter.value,dessineGargaison(partie.nombreConteneur-1),partie.statut="start",vaisseau.degat=0,vaisseau.x=50,vaisseau.y=100,vaisseau.cargaison=!1,activeUneDestination(),deplaceVaisseau(),gravite.start()});let gamePause=function(){activePause(),hideStatutSection(),DIALOG_SECTION_PAUSE.classList.remove("hide")},gameWin=function(){activePause(),hideStatutSection(),DIALOG_SECTION_WIN.classList.remove("hide")},gameLoose=function(){activePause(),hideStatutSection(),DIALOG_SECTION_LOOSE.classList.remove("hide")},activePause=function(){partie.statut="pause",DIALOG_SATUT.showModal(),DIALOG_START.close()},hideStatutSection=function(){DIALOG_SECTION_WIN.classList.add("hide"),DIALOG_SECTION_PAUSE.classList.add("hide"),DIALOG_SECTION_LOOSE.classList.add("hide")};